name: DevSecOps Security Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  security:
    name: Run Security Scans
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # 1. Run Semgrep (SAST)
    - name: Run Semgrep
      uses: returntocorp/semgrep-action@v1
      with:
        config: "auto"

    # 2. Run Gitleaks (Secrets scanning)
    - name: Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: .gitleaks.toml
        fail: true

    # 3. Run Trivy (SCA + Image Scan)
    - name: Install Trivy
      run: |
        sudo apt-get install wget -y
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.deb
        sudo dpkg -i trivy_0.50.1_Linux-64bit.deb

    - name: Run Trivy on filesystem
      run: |
        trivy fs --exit-code 1 --severity HIGH,CRITICAL .

    # 4. Run Checkov (IaC security)
    - name: Run Checkov
      uses: bridgecrewio/checkov-action@master
      with:
        directory: ./

