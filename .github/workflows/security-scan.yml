name: DevSecOps Security Scanning with HTML Reports

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security-scans:
    name: Run Security Scans
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3

    # -------------------------------------
    # 1. SEMGREP (Static Code Analysis)
    # -------------------------------------
    - name: ğŸ”§ Install Semgrep
      run: |
        pip install semgrep

    - name: ğŸ” Run Semgrep (SAST)
      run: |
        semgrep --config auto --json > semgrep-report.json || true

    - name: ğŸŒ Generate Semgrep HTML Report
      run: |
        echo '<html><body><h2>Semgrep Report</h2><pre>' > semgrep-report.html
        cat semgrep-report.json | jq '.' >> semgrep-report.html
        echo '</pre></body></html>' >> semgrep-report.html

    # -------------------------------------
    # 2. GITLEAKS (Secrets Scanning)
    # -------------------------------------
    - name: ğŸ” Run Gitleaks (Secrets Scanning)
      run: |
        curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_8.18.1_linux_x64.tar.gz | tar -xz
        chmod +x gitleaks
        ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

    # -------------------------------------
    # 3. TRIVY (SCA & Filesystem)
    # -------------------------------------
    - name: ğŸ³ Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.deb
        sudo dpkg -i trivy_0.50.1_Linux-64bit.deb

    - name: ğŸ§ª Run Trivy SCA
      run: |
        trivy fs . --format json --output trivy-report.json || true

    - name: ğŸŒ Generate Trivy HTML Report
      run: |
        echo '<html><body><h2>Trivy Report</h2><pre>' > trivy-report.html
        cat trivy-report.json | jq '.' >> trivy-report.html
        echo '</pre></body></html>' >> trivy-report.html

    # -------------------------------------
    # 4. Upload Reports as Artifacts
    # -------------------------------------
    - name: ğŸ“¦ Upload Scan Reports
      uses: actions/upload-artifact@v3
      with:
        name: security-scan-reports
        path: |
          semgrep-report.json
          semgrep-report.html
          gitleaks-report.json
          trivy-report.json
          trivy-report.html
