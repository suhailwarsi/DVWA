name: DevSecOps Security Scanning

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  security-scans:
    name: Run Security Scans
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    # -------------------------------------
    # 1. SEMGREP (SAST - Static Code Analysis)
    # -------------------------------------
    - name: ğŸ”§ Install Semgrep
      run: pip install semgrep

    - name: ğŸ” Run Semgrep
      run: |
        semgrep --config auto --json > semgrep-report.json || true

    # -------------------------------------
    # 2. GITLEAKS (Secrets Scanning)
    # -------------------------------------
    - name: ğŸ” Run Gitleaks
      run: |
        curl -sSL https://github.com/gitleaks/gitleaks/releases/latest/download/gitleaks_8.18.1_linux_x64.tar.gz | tar -xz
        chmod +x gitleaks
        ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

    # -------------------------------------
    # 3. TRIVY (SCA + Filesystem Scanning)
    # -------------------------------------
    - name: ğŸ³ Install Trivy
      run: |
        wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.1_Linux-64bit.deb
        sudo dpkg -i trivy_0.50.1_Linux-64bit.deb

    - name: ğŸ§ª Run Trivy
      run: |
        trivy fs . --format json --output trivy-report.json || true

    # -------------------------------------
    # 4. Upload Reports to GitHub Artifacts
    # -------------------------------------
    - name: ğŸ“¦ Upload Scan Reports
      uses: actions/upload-artifact@v4
      with:
        name: security-scan-reports
        path: |
          semgrep-report.json
          gitleaks-report.json
          trivy-report.json
